const cloud = require('wx-server-sdk')
cloud.init()
exports.main = async (event, context) => {
  if(!event.envID) return { errCode: -1, errMsg: '环境id为空' }

  cloud.init({
      env: event.envID
  }) 
  const db = cloud.database({
      env: event.envID
  })

  let components = await db.collection('Components').get() // TODO 查询具有 100 条限制，目前 105 https://developers.weixin.qq.com/miniprogram/dev/wxcloud/guide/database/read.html
  components = components.data

  const targetText = event.text || ''
  const targetTextKeywords = getMatchedKeywords(targetText, keywords)

  const sortedComponents = components.sort((c1, c2) => {
    const text1 = comp2text(c1)
    const text2 = comp2text(c2)
    return textCompare(text1, text2, targetTextKeywords)
  })

  const recommendComponents = sortedComponents.slice(0, 4)

  return recommendComponents 
}

function getMatchedKeywords (text, keywords) {
  let keywordsCount = 0
  const matchedKeywords = []
  for (const keyword of keywords) {
    const matchArr = text.match(keyword)
    if (matchArr !== null) {
      keywordsCount += 1
      matchedKeywords.push(keyword)
    }
  }
  return matchedKeywords
}

function textCompare (text1, text2, keywords) {
  const text1MatchedKeywords = getMatchedKeywords(text1, keywords)
  const text2MatchedKeywords = getMatchedKeywords(text2, keywords)
  return text2MatchedKeywords.length - text1MatchedKeywords.length
}

function comp2text (component) {
  let text = ''
  let code = component.code
  for (const value of Object.values(code)) {
    text += `\n${value}`
  }
  return text
}

const keywords = ["简易教程","基础","起步","申请帐号","安装开发工具","你的第一个小程序","编译预览","代码构成","JSON","WXML","WXSS","JS","小程序能力","小程序的启动","程序与页面","组件","API","发布前的准备","用户身份","预览","上传代码","小程序的版本","上线","提交审核","发布","运营数据","体验小程序","框架","目录结构","配置","全局配置","页面配置","逻辑层","注册程序","场景值","注册页面","初始数据","生命周期回调函数","页面事件处理函数","组件事件处理函数","route","setData","页面生命周期","路由","模块化","视图层","数据绑定","列表渲染","条件渲染","模板","事件","引用","基础组件","WXS","模块","变量","注释","运算符","语句","数据类型","基础类库","获取界面上的节点信息","响应显示区域变化","自定义组件","组件模板和样式","Component","组件事件","组件生命周期","behaviors","组件间关系","抽象节点","自定义组件扩展","开发第三方自定义组件","单元测试","插件","开发插件","使用插件","插件使用组件的限制","插件功能页","用户信息功能页","支付功能页","收货地址功能页","基础能力","网络","使用说明","局域网通信","存储","文件系统","画布","分包加载","使用分包","独立分包","分包预下载","Worker","硬件能力","蓝牙","NFC","Wi-Fi","开放能力","用户信息","小程序登录","UnionID","授权","开放数据校验与解密","获取手机号","生物认证","转发","动态消息","App","消息","模板消息","统一服务消息","客服消息","概述","接收消息和事件","发送消息","转发消息","下发客服输入状态","临时素材","卡券","会员卡组件","获取二维码","数据分析","附近的小程序","可用性","调试","运行环境","平台差异","ES6","运行机制","性能","优化建议","分析工具","基础库","版本分布","与客户端版本对应关系","低版本兼容","更新日志","v2.x","v1.x","v0.x","视图容器","view","scroll-view","swiper","movable-view","movable-area","cover-view","cover-image","基础内容","icon","text","rich-text","progress","表单组件","button","checkbox","form","input","label","picker","picker-view","radio","slider","switch","textarea","导航","navigator","functional-page-navigator","媒体组件","audio","image","video","camera","live-player","live-pusher","地图","map","canvas","open-data","web-view","ad","official-account","原生组件说明","wx.canIUse","系统","系统信息","wx.getSystemInfoSync","wx.getSystemInfo","更新","wx.getUpdateManager","UpdateManager","UpdateManager.onCheckForUpdate","UpdateManager.onUpdateReady","UpdateManager.onUpdateFailed","UpdateManager.applyUpdate","小程序","生命周期","wx.getLaunchOptionsSync","应用级事件","wx.offPageNotFound","wx.onPageNotFound","wx.offError","wx.onError","wx.offAppShow","wx.onAppShow","wx.offAppHide","wx.onAppHide","定时器","setTimeout","clearTimeout","setInterval","clearInterval","wx.setEnableDebug","wx.getLogManager","LogManager","LogManager.debug","LogManager.info","LogManager.log","LogManager.warn","console","console.debug","console.log","console.info","console.warn","console.error","console.group","console.groupEnd","wx.navigateBack","wx.switchTab","wx.navigateTo","wx.reLaunch","wx.redirectTo","界面","交互","wx.showActionSheet","wx.hideLoading","wx.showLoading","wx.hideToast","wx.showToast","wx.showModal","导航栏","wx.setNavigationBarColor","wx.hideNavigationBarLoading","wx.showNavigationBarLoading","wx.setNavigationBarTitle","背景","wx.setBackgroundTextStyle","wx.setBackgroundColor","Tab Bar","wx.setTabBarItem","wx.setTabBarStyle","wx.hideTabBar","wx.showTabBar","wx.hideTabBarRedDot","wx.showTabBarRedDot","wx.removeTabBarBadge","wx.setTabBarBadge","下拉刷新","wx.stopPullDownRefresh","wx.startPullDownRefresh","滚动","wx.pageScrollTo","动画","wx.createAnimation","Animation","Animation.export","Animation.step","Animation.matrix","Animation.matrix3d","Animation.rotate","Animation.rotate3d","Animation.rotateX","Animation.rotateY","Animation.rotateZ","Animation.scale","Animation.scale3d","Animation.scaleX","Animation.scaleY","Animation.scaleZ","Animation.skew","Animation.skewX","Animation.skewY","Animation.translate","Animation.translate3d","Animation.translateX","Animation.translateY","Animation.translateZ","Animation.opacity","Animation.backgroundColor","Animation.width","Animation.height","Animation.left","Animation.right","Animation.top","Animation.bottom","置顶","wx.setTopBarText","wx.nextTick","菜单","wx.getMenuButtonBoundingClientRect","窗口","wx.offWindowResize","wx.onWindowResize","发起请求","wx.request","RequestTask","RequestTask.abort","RequestTask.onHeadersReceived","RequestTask.offHeadersReceived","下载","wx.downloadFile","DownloadTask","DownloadTask.onProgressUpdate","DownloadTask.offProgressUpdate","DownloadTask.abort","DownloadTask.onHeadersReceived","DownloadTask.offHeadersReceived","上传","wx.uploadFile","UploadTask","UploadTask.onProgressUpdate","UploadTask.offProgressUpdate","UploadTask.abort","UploadTask.onHeadersReceived","UploadTask.offHeadersReceived","WebSocket","wx.onSocketError","wx.onSocketMessage","wx.onSocketClose","wx.onSocketOpen","wx.sendSocketMessage","wx.closeSocket","wx.connectSocket","SocketTask","SocketTask.send","SocketTask.close","SocketTask.onOpen","SocketTask.onClose","SocketTask.onError","SocketTask.onMessage","mDNS","wx.offLocalServiceResolveFail","wx.onLocalServiceResolveFail","wx.offLocalServiceDiscoveryStop","wx.onLocalServiceDiscoveryStop","wx.offLocalServiceLost","wx.onLocalServiceLost","wx.offLocalServiceFound","wx.onLocalServiceFound","wx.stopLocalServiceDiscovery","wx.startLocalServiceDiscovery","数据缓存","wx.getStorageInfoSync","wx.getStorageInfo","wx.clearStorageSync","wx.clearStorage","wx.removeStorageSync","wx.removeStorage","wx.setStorageSync","wx.setStorage","wx.getStorageSync","wx.getStorage","媒体","wx.createMapContext","MapContext","MapContext.getCenterLocation","MapContext.moveToLocation","MapContext.translateMarker","MapContext.includePoints","MapContext.getRegion","MapContext.getScale","图片","wx.compressImage","wx.saveImageToPhotosAlbum","wx.getImageInfo","wx.previewImage","wx.chooseImage","视频","wx.saveVideoToPhotosAlbum","wx.chooseVideo","wx.createVideoContext","VideoContext","VideoContext.play","VideoContext.pause","VideoContext.stop","VideoContext.seek","VideoContext.sendDanmu","VideoContext.playbackRate","VideoContext.requestFullScreen","VideoContext.exitFullScreen","VideoContext.showStatusBar","VideoContext.hideStatusBar","音频","wx.stopVoice","wx.pauseVoice","wx.playVoice","wx.setInnerAudioOption","wx.getAvailableAudioSources","wx.createInnerAudioContext","wx.createAudioContext","InnerAudioContext","InnerAudioContext.onCanplay","InnerAudioContext.offCanplay","InnerAudioContext.onPlay","InnerAudioContext.offPlay","InnerAudioContext.onPause","InnerAudioContext.offPause","InnerAudioContext.onStop","InnerAudioContext.offStop","InnerAudioContext.onEnded","InnerAudioContext.offEnded","InnerAudioContext.onTimeUpdate","InnerAudioContext.offTimeUpdate","InnerAudioContext.onError","InnerAudioContext.offError","InnerAudioContext.onWaiting","InnerAudioContext.offWaiting","InnerAudioContext.onSeeking","InnerAudioContext.offSeeking","InnerAudioContext.onSeeked","InnerAudioContext.offSeeked","InnerAudioContext.play","InnerAudioContext.pause","InnerAudioContext.stop","InnerAudioContext.seek","InnerAudioContext.destroy","AudioContext","AudioContext.setSrc","AudioContext.play","AudioContext.pause","AudioContext.seek","背景音频","wx.onBackgroundAudioStop","wx.onBackgroundAudioPause","wx.onBackgroundAudioPlay","wx.stopBackgroundAudio","wx.seekBackgroundAudio","wx.pauseBackgroundAudio","wx.playBackgroundAudio","wx.getBackgroundAudioPlayerState","wx.getBackgroundAudioManager","BackgroundAudioManager","BackgroundAudioManager.play","BackgroundAudioManager.pause","BackgroundAudioManager.seek","BackgroundAudioManager.stop","BackgroundAudioManager.onCanplay","BackgroundAudioManager.onWaiting","BackgroundAudioManager.onError","BackgroundAudioManager.onPlay","BackgroundAudioManager.onPause","BackgroundAudioManager.onSeeking","BackgroundAudioManager.onSeeked","BackgroundAudioManager.onEnded","BackgroundAudioManager.onStop","BackgroundAudioManager.onTimeUpdate","BackgroundAudioManager.onNext","BackgroundAudioManager.onPrev","实时音视频","wx.createLivePusherContext","wx.createLivePlayerContext","LivePlayerContext","LivePlayerContext.play","LivePlayerContext.stop","LivePlayerContext.mute","LivePlayerContext.pause","LivePlayerContext.resume","LivePlayerContext.requestFullScreen","LivePlayerContext.exitFullScreen","LivePusherContext","LivePusherContext.start","LivePusherContext.stop","LivePusherContext.pause","LivePusherContext.resume","LivePusherContext.switchCamera","LivePusherContext.snapshot","LivePusherContext.toggleTorch","LivePusherContext.playBGM","LivePusherContext.stopBGM","LivePusherContext.pauseBGM","LivePusherContext.resumeBGM","LivePusherContext.setBGMVolume","录音","wx.stopRecord","wx.startRecord","wx.getRecorderManager","RecorderManager","RecorderManager.start","RecorderManager.pause","RecorderManager.resume","RecorderManager.stop","RecorderManager.onStart","RecorderManager.onResume","RecorderManager.onPause","RecorderManager.onStop","RecorderManager.onFrameRecorded","RecorderManager.onError","RecorderManager.onInterruptionBegin","RecorderManager.onInterruptionEnd","相机","wx.createCameraContext","CameraContext","CameraContext.takePhoto","CameraContext.startRecord","CameraContext.stopRecord","字体","wx.loadFontFace","位置","wx.openLocation","wx.getLocation","wx.chooseLocation","wx.updateShareMenu","wx.showShareMenu","wx.hideShareMenu","wx.getShareInfo","wx.createCanvasContext","wx.canvasToTempFilePath","wx.canvasPutImageData","wx.canvasGetImageData","CanvasContext","CanvasContext.draw","CanvasContext.createLinearGradient","CanvasContext.createCircularGradient","CanvasContext.createPattern","CanvasContext.measureText","CanvasContext.save","CanvasContext.restore","CanvasContext.beginPath","CanvasContext.moveTo","CanvasContext.lineTo","CanvasContext.quadraticCurveTo","CanvasContext.bezierCurveTo","CanvasContext.arc","CanvasContext.rect","CanvasContext.arcTo","CanvasContext.clip","CanvasContext.fillRect","CanvasContext.strokeRect","CanvasContext.clearRect","CanvasContext.fill","CanvasContext.stroke","CanvasContext.closePath","CanvasContext.scale","CanvasContext.rotate","CanvasContext.translate","CanvasContext.drawImage","CanvasContext.strokeText","CanvasContext.transform","CanvasContext.setTransform","CanvasContext.setFillStyle","CanvasContext.setStrokeStyle","CanvasContext.setShadow","CanvasContext.setGlobalAlpha","CanvasContext.setLineWidth","CanvasContext.setLineJoin","CanvasContext.setLineCap","CanvasContext.setLineDash","CanvasContext.setMiterLimit","CanvasContext.fillText","CanvasContext.setFontSize","CanvasContext.setTextAlign","CanvasContext.setTextBaseline","CanvasGradient","CanvasGradient.addColorStop","Color","文件","wx.getFileSystemManager","wx.getFileInfo","wx.removeSavedFile","wx.getSavedFileInfo","wx.getSavedFileList","wx.openDocument","wx.saveFile","FileSystemManager","FileSystemManager.access","FileSystemManager.accessSync","FileSystemManager.appendFile","FileSystemManager.appendFileSync","FileSystemManager.saveFile","FileSystemManager.saveFileSync","FileSystemManager.getSavedFileList","FileSystemManager.removeSavedFile","FileSystemManager.copyFile","FileSystemManager.copyFileSync","FileSystemManager.getFileInfo","FileSystemManager.mkdir","FileSystemManager.mkdirSync","FileSystemManager.readFile","FileSystemManager.readFileSync","FileSystemManager.readdir","FileSystemManager.readdirSync","FileSystemManager.rename","FileSystemManager.renameSync","FileSystemManager.rmdir","FileSystemManager.rmdirSync","FileSystemManager.stat","FileSystemManager.statSync","FileSystemManager.unlink","FileSystemManager.unlinkSync","FileSystemManager.unzip","FileSystemManager.writeFile","FileSystemManager.writeFileSync","Stats","Stats.isDirectory","Stats.isFile","开放接口","登录","wx.checkSession","wx.login","code2Session","小程序跳转","wx.navigateToMiniProgram","wx.navigateBackMiniProgram","帐号信息","wx.getAccountInfoSync","wx.getUserInfo","getPaidUnionId","UserInfo","接口调用凭证","getAccessToken","数据上报","wx.reportMonitor","wx.reportAnalytics","访问留存","getAnalysisDailyRetain","getAnalysisMonthlyRetain","getAnalysisWeeklyRetain","getAnalysisDailySummary","访问趋势","getAnalysisDailyVisitTrend","getAnalysisMonthlyVisitTrend","getAnalysisWeeklyVisitTrend","getAnalysisUserPortrait","getAnalysisVisitDistribution","getAnalysisVisitPage","支付","wx.requestPayment","wx.authorize","设置","wx.openSetting","wx.getSetting","AuthSetting","customerTyping","getTempMedia","sendCustomerMessage","uploadTempMedia","addTemplate","deleteTemplate","getTemplateLibraryById","getTemplateLibraryList","getTemplateList","sendTemplateMessage","sendUniformMessage","createActivityId","setUpdatableMsg","插件管理","applyPlugin","getPluginDevApplyList","getPluginList","setDevPluginApplyStatus","unbindPlugin","收货地址","wx.chooseAddress","wx.openCard","wx.addCard","发票","wx.chooseInvoiceTitle","wx.chooseInvoice","addNearbyPoi","deleteNearbyPoi","getNearbyPoiList","setNearbyPoiShowStatus","二维码","createWXAQRCode","getWXACode","getWXACodeUnlimit","内容安全","imgSecCheck","msgSecCheck","wx.startSoterAuthentication","wx.checkIsSupportSoterAuthentication","wx.checkIsSoterEnrolledInDevice","微信运动","wx.getWeRunData","设备","iBeacon","wx.onBeaconServiceChange","wx.onBeaconUpdate","wx.getBeacons","wx.stopBeaconDiscovery","wx.startBeaconDiscovery","IBeaconInfo","wx.stopWifi","wx.startWifi","wx.setWifiList","wx.onWifiConnected","wx.onGetWifiList","wx.getWifiList","wx.getConnectedWifi","wx.connectWifi","WifiInfo","加速计","wx.onAccelerometerChange","wx.stopAccelerometer","wx.startAccelerometer","电量","wx.getBatteryInfoSync","wx.getBatteryInfo","剪贴板","wx.setClipboardData","wx.getClipboardData","罗盘","wx.onCompassChange","wx.stopCompass","wx.startCompass","联系人","wx.addPhoneContact","陀螺仪","wx.onGyroscopeChange","wx.stopGyroscope","wx.startGyroscope","设备方向","wx.onDeviceMotionChange","wx.stopDeviceMotionListening","wx.startDeviceMotionListening","wx.onNetworkStatusChange","wx.getNetworkType","电话","wx.makePhoneCall","扫码","wx.scanCode","振动","wx.vibrateLong","wx.vibrateShort","wx.onMemoryWarning","低功耗蓝牙","wx.writeBLECharacteristicValue","wx.readBLECharacteristicValue","wx.onBLEConnectionStateChange","wx.onBLECharacteristicValueChange","wx.notifyBLECharacteristicValueChange","wx.getBLEDeviceServices","wx.getBLEDeviceCharacteristics","wx.createBLEConnection","wx.closeBLEConnection","wx.stopBluetoothDevicesDiscovery","wx.startBluetoothDevicesDiscovery","wx.openBluetoothAdapter","wx.onBluetoothDeviceFound","wx.onBluetoothAdapterStateChange","wx.getConnectedBluetoothDevices","wx.getBluetoothDevices","wx.getBluetoothAdapterState","wx.closeBluetoothAdapter","wx.stopHCE","wx.startHCE","wx.sendHCEMessage","wx.onHCEMessage","wx.getHCEState","屏幕","wx.setScreenBrightness","wx.setKeepScreenOn","wx.onUserCaptureScreen","wx.getScreenBrightness","wx.createWorker","Worker.postMessage","Worker.onMessage","Worker.terminate","第三方平台","wx.getExtConfigSync","wx.getExtConfig","wx.createSelectorQuery","wx.createIntersectionObserver","IntersectionObserver","IntersectionObserver.relativeTo","IntersectionObserver.relativeToViewport","IntersectionObserver.observe","IntersectionObserver.disconnect","NodesRef","NodesRef.fields","NodesRef.boundingClientRect","NodesRef.scrollOffset","NodesRef.context","SelectorQuery","SelectorQuery.in","SelectorQuery.select","SelectorQuery.selectAll","SelectorQuery.selectViewport","SelectorQuery.exec","工具","概览","启动页","菜单栏","工具栏","工具栏管理","模拟器","独立窗口","外观设置","编辑设置","代理设置","项目页卡","项目设置","域名信息","快捷键","代码编辑","文件格式","文件类型","自动补全","Git","项目配置文件","小程序调试","自定义编译","自定义预处理","前后台切换","调试工具","Wxml Panel","Sources Panel","AppData Panel","Storage Panel","Network Panel","Console Panel","Sensor Panel","自定义数据上报","自动预览","特殊场景调试","真机调试","多帐号调试","npm","体验评分","命令行调用","HTTP","测试号","小程序开发助手","代码片段","小程序插件开发","代码托管","云测试","Beta","历史更新日志","·","我的第一个云开发小程序","兼容性问题","开通云开发","云开发控制台","云开发能力","数据库","云函数","插件使用云开发","开发指引","指引","控制台","初始化","上手","权限管理","插入数据","读取数据","构建查询条件","更新数据","删除数据","索引","导入","导出","管理文件","我的第一个云函数","获取小程序用户信息","异步返回结果","wx-server-sdk","定时触发器","注意事项","管理云函数","测试、日志与监控","参考信息","错误码","配额","IDE &","database","collection","collection.doc","collection.get","doc.get","collection.add","doc.update","doc.set","doc.remove","collection.count","collection.where","collection.orderBy","collection.limit","collection.skip","collection.field","db.command","db.regexp","db.serverDate","db.Geo","command.eq","command.neq","command.lt","command.lte","command.gt","command.gte","command.in","command.nin","command.and","command.or","command.set","command.remove","command.inc","command.mul","command.push","command.pop","command.shift","command.unshfit","get","update","remove","wx.cloud.uploadFile","wx.cloud.downloadFile","wx.cloud.getTempFileURL","wx.cloud.deleteFile","wx.cloud.callFunction","组件支持","工具类","getWXContext","collection.update","collection.remove","db.createCollection","uploadFile","downloadFile","getTempFileURL","deleteFile","callFunction"]
